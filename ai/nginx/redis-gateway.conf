worker_processes 1;
events { worker_connections 1024; }

http {
  # CORS 전부 허용(문제 재발 방지). 필요 시 화이트리스트로 축소.
  map $http_origin $cors_ok { default 1; }

  server {
    listen 80;

    # set $AI_API_KEY "....";
    include /etc/nginx/secrets/ai_api_key.conf;

    add_header Access-Control-Allow-Origin  $http_origin  always;
    add_header Access-Control-Allow-Headers "Content-Type,X-AI-API-Key" always;
    add_header Access-Control-Allow-Methods "GET,OPTIONS" always;

    if ($request_method = OPTIONS) { return 204; }
    if ($http_x_ai_api_key != $AI_API_KEY) { return 401; }

    # FastAPI 프록시. 게이트웨이 키를 FastAPI 기대 헤더명으로 전달.
    location /api-redis/ {
      proxy_pass http://api-redis:8010/;
      proxy_set_header Host $host;
      proxy_set_header X-API-Key $http_x_ai_api_key;
    }

    # Webdis 프록시
    location /webdis/ {
      proxy_pass http://webdis:7379/;
      proxy_set_header Host $host;
    }
    location /zrevrange/ {
      proxy_pass http://webdis:7379/ZREVRANGE/;
      proxy_set_header Host $host;
    }

    location = / { return 404; }
  }
}
