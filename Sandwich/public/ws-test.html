<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WS Chat Quick Tester</title>
    <style>
        body {font-family: ui-monospace, SFMono-Regular, Menlo, monospace}
        .grid {display:grid;gap:8px;max-width:720px}
        .row {display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        pre {background:#111;color:#0f0;padding:12px;min-height:220px;overflow:auto}
        input,select,button{padding:6px 8px}
        button:disabled{opacity:.5}
        label {display:block}
    </style>
</head>
<body>
<h3>WS Chat Quick Tester</h3>

<div class="grid">
    <label>Base URL (Ïòà: http://localhost:8080)
        <input id="baseUrl" value="http://localhost:8080" style="width:100%">
    </label>

    <label>JWT Access Token (Bearer ÏóÜÏù¥ ÏÉùÌÜ†ÌÅ∞Îßå)
        <input id="token" placeholder="eyJhbGciOi..." style="width:100%">
    </label>

    <div class="row">
        <label>Room ID
            <input id="roomId" type="number" placeholder="123">
        </label>
        <button id="btnConnect">Connect</button>
        <button id="btnDisconnect" disabled>Disconnect</button>
    </div>

    <div class="row">
        <button id="btnSubscribeRoom" disabled>Subscribe Room</button>
        <button id="btnUnsubRoom" disabled>Unsubscribe Room</button>
        <span id="roomSubInfo" style="opacity:.8"></span>
    </div>

    <label>Type
        <select id="type">
            <option>GENERAL</option>
            <option>EMOJI</option>
            <option>JOB_OFFER</option>
            <option>PROJECT_OFFER</option>
        </select>
    </label>

    <label>Content / Ïπ¥Îìú ÏÑ§Î™Ö
        <input id="content" placeholder="ÏïàÎÖï! ÎòêÎäî üòä" style="width:100%">
    </label>

    <div class="row">
        <button id="btnSend" disabled>Send</button>
        <button id="btnRead" disabled>Mark Read</button>
        <button id="btnTypingStart" disabled>Typing Start</button>
        <button id="btnTypingStop" disabled>Typing Stop</button>
    </div>

    <!-- Presence -->
    <div class="row">
        <label>Presence User ID
            <input id="presenceUserId" type="number" placeholder="ÏÉÅÎåÄ userId">
        </label>
        <button id="btnPresenceSub" disabled>Subscribe Presence</button>
        <button id="btnPresenceUnsub" disabled>Unsubscribe Presence</button>
        <span id="presenceSubInfo" style="opacity:.8"></span>
    </div>

    <!-- Notify (Í∞úÏù∏ ÏïåÎ¶º) -->
    <div class="row">
        <label>Notify User ID
            <input id="notifyUserId" type="number" placeholder="ÎÇ¥ userId">
        </label>
        <button id="btnNotifySub" disabled>Subscribe Notifications</button>
        <button id="btnNotifyUnsub" disabled>Unsubscribe</button>
        <span id="notifySubInfo" style="opacity:.8"></span>
    </div>

    <!-- Web Push (FCM) -->
    <div class="row">
        <button id="btnPushRegister" disabled>Register Web Push</button>
        <button id="btnPushUnregister" disabled>Unregister</button>
        <span id="pushInfo" style="opacity:.8"></span>
    </div>

    <pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stomp, roomSub, presenceSub, notifySub;
    const el = id => document.getElementById(id);
    const log = (...a) => { el('log').textContent += a.join(' ') + "\n"; el('log').scrollTop = el('log').scrollHeight; };

    function connect() {
      const base = el('baseUrl').value.replace(/\/$/, '');
      const token = el('token').value.trim();
      if (!token) return alert('ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');

      const url = base + '/ws/chat?token=' + encodeURIComponent('Bearer ' + token);
      const socket = new SockJS(url);
      stomp = Stomp.over(socket);
      stomp.debug = null;

      stomp.connect({}, () => {
        log('[WS] connected');
        setConnected(true);
      }, (err) => {
        log('[WS] error', err);
        setConnected(false);
      });
    }

    function disconnect() {
      if (roomSub) { roomSub.unsubscribe(); roomSub = null; }
      if (presenceSub) { presenceSub.unsubscribe(); presenceSub = null; }
      if (notifySub) { notifySub.unsubscribe(); notifySub = null; }
      if (stomp) stomp.disconnect(() => log('[WS] disconnected'));
      setConnected(false);
    }

    function setConnected(on) {
      el('btnDisconnect').disabled = !on;
      el('btnSubscribeRoom').disabled = !on;
      el('btnUnsubRoom').disabled = !on;
      el('btnSend').disabled = !on;
      el('btnRead').disabled = !on;
      el('btnTypingStart').disabled = !on;
      el('btnTypingStop').disabled = !on;
      el('btnPresenceSub').disabled = !on;
      el('btnPresenceUnsub').disabled = !on;
      el('btnNotifySub').disabled = !on;
      el('btnNotifyUnsub').disabled = !on;
      el('btnPushRegister').disabled = !on;
      el('btnPushUnregister').disabled = !on;
    }

    // Room subscribe
    function subscribeRoom() {
      const roomId = el('roomId').value.trim();
      if (!roomId) return alert('roomId ÏûÖÎ†•');
      if (roomSub) roomSub.unsubscribe();
      roomSub = stomp.subscribe('/topic/rooms/' + roomId, msg => {
        log('[RECV][ROOM ' + roomId + ']', msg.body);
      });
      el('roomSubInfo').textContent = 'sub: /topic/rooms/' + roomId;
      log('[SUB][ROOM] /topic/rooms/' + roomId);
    }
    function unsubscribeRoom() {
      if (roomSub) {
        roomSub.unsubscribe(); roomSub = null;
        el('roomSubInfo').textContent = 'unsubscribed';
        log('[UNSUB][ROOM]');
      }
    }

    // Send/Read/Typing
    function sendMsg() {
      const roomId = el('roomId').value.trim();
      const type = el('type').value;
      const content = el('content').value;
      if (!roomId) return alert('roomId ÏûÖÎ†•');
      const payload = { roomId: Number(roomId), type, content };
      stomp.send('/app/messages.send.' + roomId, {}, JSON.stringify(payload));
      log('[SEND]', JSON.stringify(payload));
    }
    function markRead() {
      const roomId = el('roomId').value.trim();
      if (!roomId) return alert('roomId ÏûÖÎ†•');
      stomp.send('/app/messages.read.' + roomId, {}, '{}');
      log('[READ] room ' + roomId);
    }
    function typingStart() {
      const roomId = el('roomId').value.trim();
      if (!roomId) return alert('roomId ÏûÖÎ†•');
      stomp.send('/app/typing.start.' + roomId, {}, '{}');
      log('[TYPING_START] room ' + roomId);
    }
    function typingStop() {
      const roomId = el('roomId').value.trim();
      if (!roomId) return alert('roomId ÏûÖÎ†•');
      stomp.send('/app/typing.stop.' + roomId, {}, '{}');
      log('[TYPING_STOP] room ' + roomId);
    }

    // Presence
    function subscribePresence() {
      const uid = el('presenceUserId').value.trim();
      if (!uid) return alert('Presence userId ÏûÖÎ†•');
      if (presenceSub) presenceSub.unsubscribe();
      presenceSub = stomp.subscribe('/topic/presence/' + uid, msg => {
        log('[RECV][PRESENCE ' + uid + ']', msg.body);
      });
      el('presenceSubInfo').textContent = 'sub: /topic/presence/' + uid;
      log('[SUB][PRESENCE] /topic/presence/' + uid);
    }
    function unsubscribePresence() {
      if (presenceSub) {
        presenceSub.unsubscribe(); presenceSub = null;
        el('presenceSubInfo').textContent = 'unsubscribed';
        log('[UNSUB][PRESENCE]');
      }
    }

    // Notify
    function subscribeNotify() {
      const uid = el('notifyUserId').value.trim();
      if (!uid) return alert('userId ÏûÖÎ†•');
      if (notifySub) notifySub.unsubscribe();
      const dest = '/topic/users/' + uid + '/notifications';
      notifySub = stomp.subscribe(dest, msg => {
        log('[RECV][NOTIFY ' + uid + ']', msg.body);
      });
      el('notifySubInfo').textContent = 'sub: ' + dest;
      log('[SUB][NOTIFY] ' + dest);
    }
    function unsubscribeNotify() {
      if (notifySub) {
        notifySub.unsubscribe(); notifySub = null;
        el('notifySubInfo').textContent = 'unsubscribed';
        log('[UNSUB][NOTIFY]');
      }
    }

    // bind
    el('btnConnect').onclick = connect;
    el('btnDisconnect').onclick = disconnect;
    el('btnSubscribeRoom').onclick = subscribeRoom;
    el('btnUnsubRoom').onclick = unsubscribeRoom;
    el('btnSend').onclick = sendMsg;
    el('btnRead').onclick = markRead;
    el('btnTypingStart').onclick = typingStart;
    el('btnTypingStop').onclick = typingStop;
    el('btnPresenceSub').onclick = subscribePresence;
    el('btnPresenceUnsub').onclick = unsubscribePresence;
    el('btnNotifySub').onclick = subscribeNotify;
    el('btnNotifyUnsub').onclick = unsubscribeNotify;
</script>

<!-- Firebase v12 Î™®Îìà: Web Push Îì±Î°ù/Ìï¥Ï†ú -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEu2qTgKqvnPm0c9LU8u69xi-lELSWpp8",
      authDomain: "sandwich-b3e09.firebaseapp.com",
      projectId: "sandwich-b3e09",
      storageBucket: "sandwich-b3e09.firebasestorage.app",
      messagingSenderId: "1097062424285",
      appId: "1:1097062424285:web:67ea70c23d90de8ba0c534"
    };

    const VAPID_PUBLIC_KEY = "BPfv2mducX32XZ2U3xb_DSkGCY_TRU-SwHpmRjTn43NjA1CRmhU6lKNpPWG5XbMdX5XeaxjgKEQUjTllnNake4E";

    const appFB = initializeApp(firebaseConfig);
    const messaging = getMessaging(appFB);
    let pushToken = null;

    async function registerPush() {
      try {
        const jwtRaw = document.getElementById('token').value.trim();
        if (!jwtRaw) return alert('Access Token Î®ºÏ†Ä ÏûÖÎ†•');

        // SW Îì±Î°ù (Î£®Ìä∏Ïóê /firebase-messaging-sw.js ÌïÑÏöî)
        const swUrl = '/firebase-messaging-sw.js?v=' + Date.now();
        const reg = await navigator.serviceWorker.register(swUrl);

        // Í∂åÌïú ÏöîÏ≤≠
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          console.warn('[PUSH] permission=', perm);
          return;
        }

        // ÌÜ†ÌÅ∞ Î∞úÍ∏â (VAPID ÌïÑÏàò)
        pushToken = await getToken(messaging, { vapidKey: VAPID_PUBLIC_KEY, serviceWorkerRegistration: reg });
        console.log('[FCM] token', pushToken);

        // ÏÑúÎ≤Ñ Îì±Î°ù
        const res = await fetch('/api/push/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + jwtRaw },
          body: JSON.stringify({ platform: 'WEB', token: pushToken })
        });
        const js = await res.json().catch(()=>({}));
        document.getElementById('pushInfo').textContent = 'registered: ...' + (pushToken?.slice(-8) || '');
        console.log('[REGISTER]', res.status, js);
      } catch (e) {
        console.error('[PUSH][ERR]', e);
        alert('Push Îì±Î°ù Ïã§Ìå®: ' + (e?.message || e));
      }
    }

    async function unregisterPush() {
      try {
        const jwtRaw = document.getElementById('token').value.trim();
        if (!jwtRaw) return alert('Access Token Î®ºÏ†Ä ÏûÖÎ†•');
        if (!pushToken) return alert('Î®ºÏ†Ä RegisterÎ°ú ÌÜ†ÌÅ∞ÏùÑ Î∞úÍ∏âÌïòÏÑ∏Ïöî');

        const res = await fetch('/api/push/register?token=' + encodeURIComponent(pushToken), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + jwtRaw }
        });
        const js = await res.json().catch(()=>({}));
        document.getElementById('pushInfo').textContent = 'unregistered';
        console.log('[UNREGISTER]', res.status, js);
      } catch (e) {
        console.error('[PUSH][ERR]', e);
      }
    }

    // WS Ïó∞Í≤∞ÎêòÎ©¥ Î≤ÑÌäº ÌôúÏÑ±Ìôî(Í∏∞Ï°¥ setConnected ÌõÖÌÇπ)
    const origSetConnected = window.setConnected;
    window.setConnected = function(on){
      origSetConnected(on);
      document.getElementById('btnPushRegister').disabled = !on;
      document.getElementById('btnPushUnregister').disabled = !on;
    };

    document.getElementById('btnPushRegister').onclick = registerPush;
    document.getElementById('btnPushUnregister').onclick = unregisterPush;

    // Ìè¨Í∑∏ÎùºÏö¥Îìú Î©îÏãúÏßÄ ÏàòÏã† (ÌÉ≠ Ïó¥Î†§ÏûàÏùÑ ÎïåÎèÑ ÌëúÏãú)
    onMessage(messaging, (payload) => {
      console.log('[FCM][FOREGROUND]', payload);
      const data = payload.data || {};
      const text = (data.senderName ? `${data.senderName}: ` : '') + (data.preview || '');
      alert(text || 'ÏÉà Î©îÏãúÏßÄ');  // Í∞ÑÎã® ÏïåÎ¶º
    });
</script>
</body>
</html>
